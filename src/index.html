<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>HOLC — auto-detect layer (MapTiler)</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link href="https://unpkg.com/maplibre-gl@1.15.2/dist/maplibre-gl.css" rel="stylesheet"/>
  <script src="https://unpkg.com/maplibre-gl@1.15.2/dist/maplibre-gl.js"></script>
  <style>
    body { margin:0; font-family: Arial, Helvetica, sans-serif; }
    .tabs { display:flex; gap:8px; padding:10px; background:#f5f6f8; }
    .tab { padding:8px 12px; border-radius:6px; cursor:pointer; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,0.06); }
    .tab.active { background:#0b6cff; color:#fff }
    #map, #graphs { position:absolute; top:56px; bottom:0; left:0; right:0; }
    #graphs { display:none; padding:20px; overflow:auto; background:#fff; }
    #info { position:absolute; left:12px; top:72px; background:#fff; padding:8px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.12); z-index:2; max-width:360px; }
    .legend { position:absolute; right:12px; top:72px; background:#fff; padding:10px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.12); z-index:2; font-size:13px; }
    .swatch { width:18px; height:12px; border-radius:2px; border:1px solid rgba(0,0,0,0.08); display:inline-block; margin-right:8px; vertical-align:middle; }
    .legend .row { margin-bottom:6px; }
  </style>
</head>
<body>
  <div class="tabs">
    <div id="tab-map" class="tab active">Map</div>
    <div id="tab-graphs" class="tab">Graphs & Info</div>
  </div>

  <div id="map"></div>
  <div id="graphs"><h2>Graphs & policy text</h2><p>Drop your charts or narrative here.</p></div>

  <div id="info">Hover a polygon</div>

  <div class="legend" aria-hidden="true">
    <div style="font-weight:600; margin-bottom:6px;">HOLC grade</div>
    <div class="row"><span class="swatch" style="background:#2ca25f"></span>A</div>
    <div class="row"><span class="swatch" style="background:#1f78b4"></span>B</div>
    <div class="row"><span class="swatch" style="background:#f1c40f"></span>C</div>
    <div class="row"><span class="swatch" style="background:#e34a33"></span>D</div>
    <div class="row"><span class="swatch" style="background:#999999"></span>Other</div>
  </div>

<script>
// ========== TileJSON URL ==========
const TILEJSON_URL = "https://api.maptiler.com/tiles/01990763-49f0-77ce-b1b1-b97328f38e70/tiles.json?key=PrTVbrUk3PBatpAWhyvh";

// UI for tabs
const tabMap = document.getElementById('tab-map');
const tabGraphs = document.getElementById('tab-graphs');
const mapEl = document.getElementById('map');
const graphsEl = document.getElementById('graphs');

tabMap.onclick = () => { tabMap.classList.add('active'); tabGraphs.classList.remove('active'); mapEl.style.display='block'; graphsEl.style.display='none'; if (window._map) window._map.resize(); }
tabGraphs.onclick = () => { tabGraphs.classList.add('active'); tabMap.classList.remove('active'); mapEl.style.display='none'; graphsEl.style.display='block'; }

// Async init: fetch TileJSON, detect vector layer(s), and create map
async function init() {
  let tj;
  try {
    const r = await fetch(TILEJSON_URL);
    if (!r.ok) throw new Error(`TileJSON fetch failed: ${r.status} ${r.statusText}`);
    tj = await r.json();
  } catch (err) {
    alert("Failed to fetch TileJSON. Check the TileJSON URL and API key. See console for details.");
    console.error(err);
    return;
  }

  console.log("TileJSON loaded:", tj);

  // detect layer name
  let sourceLayer = null;
  if (Array.isArray(tj.vector_layers) && tj.vector_layers.length > 0) {
    sourceLayer = tj.vector_layers[0].id;
    console.log("Detected vector_layers:", tj.vector_layers.map(v=>v.id));
  } else if (Array.isArray(tj.layers) && tj.layers.length > 0) {
    sourceLayer = tj.layers[0].id;
    console.log("Detected layers:", tj.layers.map(v=>v.id));
  } else {
    console.warn("No vector_layers found in TileJSON. Upload may not have created vector layers.");
  }

  // style with TileJSON and zoom bounds
  const style = {
    version: 8,
    sources: {
      "osm": { type: "raster", tiles: ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"], tileSize: 256 },
      "holc-tiles": { type: "vector", url: TILEJSON_URL, minzoom: tj.minzoom || 0, maxzoom: tj.maxzoom || 14 }
    },
    layers: [{ id: 'osm', type: 'raster', source: 'osm' }]
  };

  const map = new maplibregl.Map({
    container: 'map',
    style: style,
    center: [-121.8863, 37.3382], // San Jose center — change if desired
    zoom: 12
  });
  window._map = map; // for external access

  map.on('load', () => {
    if (!sourceLayer) {
      document.getElementById('info').innerText = "No vector_layers found in TileJSON. Check your MapTiler upload.";
      return;
    }
    console.log("Using source-layer:", sourceLayer);

    // Add polygon fill and outline with your color scheme:
    // A -> green, B -> blue, C -> yellow, D -> red, default gray
    map.addLayer({
      id: 'holc-fill',
      type: 'fill',
      source: 'holc-tiles',
      'source-layer': sourceLayer,
      paint: {
        'fill-color': [
          'match',
          ['get', 'grade'],
          'A', '#2ca25f',     // green
          'B', '#1f78b4',     // blue
          'C', '#f1c40f',     // yellow
          'D', '#e34a33',     // red
          /*default*/ '#999999' // grey for anything else / missing
        ],
        'fill-opacity': 0.65
      }
    });

    // Keep a crisp outline
    map.addLayer({
      id: 'holc-line',
      type: 'line',
      source: 'holc-tiles',
      'source-layer': sourceLayer,
      paint: { 'line-color': '#222', 'line-width': 1 }
    });

    // Hover + popup behavior
    const info = document.getElementById('info');
    const popup = new maplibregl.Popup({ closeButton:true, closeOnClick:true });

    map.on('mousemove', 'holc-fill', (e) => {
      map.getCanvas().style.cursor = 'pointer';
      const props = e.features?.[0]?.properties || {};
      const name = props.HOLC_NAME || props.name || props.holc_name || 'HOLC zone';
      const grade = props.grade || props.GRADE || 'N/A';
      info.innerHTML = `<strong>${name}</strong><br/>Grade: ${grade}`;
    });

    map.on('mouseleave', 'holc-fill', () => {
      map.getCanvas().style.cursor = '';
      info.innerText = 'Hover a polygon';
    });

    map.on('click', 'holc-fill', (e) => {
      const props = e.features?.[0]?.properties || {};
      let html = `<strong>${props.HOLC_NAME||props.name||'HOLC Zone'}</strong><br/>Grade: ${props.grade||props.GRADE||'N/A'}<hr/>`;
      html += '<div style="max-height:220px;overflow:auto;font-size:13px">';
      for (const k in props) {
        if (!props.hasOwnProperty(k)) continue;
        let v = props[k];
        if (typeof v === 'string' && v.length > 300) v = v.slice(0,300) + '…';
        html += `<div><strong>${k}</strong>: ${v}</div>`;
      }
      html += '</div>';
      popup.setLngLat(e.lngLat).setHTML(html).addTo(map);
    });
  });

  // helpful console output for debugging
  map.on('error', (err) => console.error('Map error:', err));
}

init();
</script>
</body>
</html>

