<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Prolonged Redlining in San Jose</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link href="https://unpkg.com/maplibre-gl@1.15.2/dist/maplibre-gl.css" rel="stylesheet"/>
  <script src="https://unpkg.com/maplibre-gl@1.15.2/dist/maplibre-gl.js"></script>
  <style>
    body { margin:0; font-family: Arial, Helvetica, sans-serif; }
    .tabs { display:flex; gap:8px; padding:10px; background:#f5f6f8; }
    .tab { padding:8px 12px; border-radius:6px; cursor:pointer; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,0.06); }
    .tab.active { background:#0b6cff; color:#fff }
    #map, #graphs { position:absolute; top:56px; bottom:0; left:0; right:0; }
    #graphs { display:none; padding:20px; overflow:auto; background:#fff; }
    #info { position:absolute; left:12px; top:72px; background:#fff; padding:8px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.12); z-index:2; max-width:360px; }
    .legend { position:absolute; right:12px; top:72px; background:#fff; padding:10px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.12); z-index:2; font-size:13px; }
    .swatch { width:18px; height:12px; border-radius:2px; border:1px solid rgba(0,0,0,0.08); display:inline-block; margin-right:8px; vertical-align:middle; }
    .legend .row { margin-bottom:6px; }
    .popup-table { font-size:13px; line-height:1.3; max-width:340px; }
    .popup-scroll { max-height:300px; overflow:auto; padding-right:8px; box-sizing:border-box; }
    .metric { font-weight:600; margin-right:6px; }
    .chart-title { font-weight:700; margin-bottom:6px; }
    .bar-row { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
    .bar-label { width:160px; font-size:13px; }
    .bar-track { background:#eee; height:18px; width:420px; border-radius:4px; overflow:hidden; }
    .bar-fill { height:100%; border-radius:4px; }
    .stat-grid { display:flex; gap:24px; flex-wrap:wrap; margin-bottom:18px; }
    .stat-card { min-width:160px; background:#fafafa; padding:10px; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.04); }
    #layer-controls { position: absolute; top: 72px; left: 12px; background: #fff; padding: 8px; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.12); font-size: 13px; z-index: 3; }
    #layer-controls label { display: block; margin-bottom: 4px; cursor: pointer; }
    .infra-legend { position:absolute; right:12px; top:180px; background:#fff; padding:10px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.12); z-index:2; font-size:13px; }
    .infra-swatch { width:18px; height:12px; border-radius:2px; border:1px solid rgba(0,0,0,0.08); display:inline-block; margin-right:8px; vertical-align:middle; }

    /* New styles for the Graphs & Info section */
    .overview-content { display: block; }
    .polygon-content { display: none; }
    #back-to-overview { margin-bottom: 20px; padding: 8px 16px; background: #0b6cff; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .graph-image { max-width: 100%; margin: 15px 0; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .call-to-action { background: #f0f7ff; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #0b6cff; }
    .research-section { margin-bottom: 30px; }
    .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
    @media (max-width: 768px) {
      .chart-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<div class="tabs">
  <div id="tab-map" class="tab active">Map</div>
  <div id="tab-graphs" class="tab">Graphs & Info</div>
</div>
<div id="map"></div>
<div id="graphs">
  <div class="overview-content">
    <h2>The Lasting Impact of Redlining in San Jose</h2>

    <div class="research-section">
      <h3>Introduction</h3>
      <p>Redlining, one of the most explicit forms of structural racism, lasted over 30 years and continues to impact U.S. cities like San Jose today. This discriminatory practice denied financial services to minority communities, creating lasting disparities in wealth and opportunity.</p>
      <p>Home ownership is the biggest driver of wealth in the US. The homeownership rate among white non-Hispanic Americans is 73.3%, compared to just 42.1% among Black Americans. This wealth gap stems directly from historical policies like redlining that systematically excluded communities of color from homeownership opportunities.</p>
    </div>

    <div class="research-section">
      <h3>Historical Background</h3>
      <p>In the 1930s, the Home Owners' Loan Corporation (HOLC) graded neighborhoods across the country:</p>
      <ul>
        <li><strong>A (Best)</strong>: Predominantly white neighborhoods that received ample investment</li>
        <li><strong>B (Still Desirable)</strong>: Mostly white neighborhoods considered good investments</li>
        <li><strong>C (Declining)</strong>: Neighborhoods with minority residents, deemed risky for investment</li>
        <li><strong>D (Hazardous)</strong>: Predominantly Black, Hispanic, and immigrant communities, systematically denied loans and investment</li>
      </ul>
      <p>These discriminatory practices isolated minority racial groups and created patterns of segregation that persist today.</p>
    </div>

    <div class="research-section">
      <h3>Key Findings: Infrastructure Disparities</h3>
      <p>My analysis reveals stark disparities in infrastructure investment between neighborhoods with different HOLC grades:</p>

      <div class="chart-grid">
        <div>
          <h4>Broadband Access</h4>
          <iframe width="506" height="315" seamless frameborder="0" scrolling="no" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRg1FjbeS85-cFpzGsRdobMtjb_Iu-JJJDjllgzePXZXgnHbJYPX94m5tHMcTfh2ebHqLBUT15gZWRM/pubchart?oid=280698462&amp;format=interactive" class="graph-image"></iframe>
          <p>Historically redlined areas (Grades C & D) have significantly fewer broadband anchors per square kilometer, limiting digital access and economic opportunities.</p>
        </div>

        <div>
          <h4>Green Infrastructure</h4>
          <iframe width="506" height="315" seamless frameborder="0" scrolling="no" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRg1FjbeS85-cFpzGsRdobMtjb_Iu-JJJDjllgzePXZXgnHbJYPX94m5tHMcTfh2ebHqLBUT15gZWRM/pubchart?oid=1010210670&amp;format=interactive" class="graph-image"></iframe>
          <iframe width="506" height="315" seamless frameborder="0" scrolling="no" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRg1FjbeS85-cFpzGsRdobMtjb_Iu-JJJDjllgzePXZXgnHbJYPX94m5tHMcTfh2ebHqLBUT15gZWRM/pubchart?oid=539685908&amp;format=interactive" class="graph-image"></iframe>
          <p>Neighborhoods graded D have far fewer street trees, contributing to urban heat island effects and reduced quality of life. Furthermore, there is significantly more rail, leading to noise and air pollution, detrimental for the health of citizens.</p>
        </div>

        <div>
          <h4>Housing Values</h4>
          <iframe width="506" height="315" seamless frameborder="0" scrolling="no" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRg1FjbeS85-cFpzGsRdobMtjb_Iu-JJJDjllgzePXZXgnHbJYPX94m5tHMcTfh2ebHqLBUT15gZWRM/pubchart?oid=1395206384&amp;format=interactive" class="graph-image"></iframe>
          <p>The legacy of redlining is clearly visible in current housing values, with formerly redlined areas having significantly lower median values.</p>
        </div>

        <div>
          <h4>Racial Demographics</h4>
          <iframe width="506" height="315" seamless frameborder="0" scrolling="no" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRg1FjbeS85-cFpzGsRdobMtjb_Iu-JJJDjllgzePXZXgnHbJYPX94m5tHMcTfh2ebHqLBUT15gZWRM/pubchart?oid=134847115&amp;format=interactive" class="graph-image"></iframe>
          <p>Historical patterns of segregation persist, with formerly redlined areas still having higher concentrations of Hispanic and Black residents.</p>
        </div>
      </div>
    </div>

    <div class="research-section">
      <h3>Policy Implications</h3>
      <p>The data reveals how historical redlining continues to shape San Jose's neighborhoods through:</p>
      <ul>
        <li><strong>Disinvestment</strong>: Formerly redlined areas have the lowest median housing values, reducing tax revenue and limiting infrastructure funding</li>
        <li><strong>Persistent Racial Disparities</strong>: These areas still have higher concentrations of Hispanic residents, reflecting lasting segregation</li>
        <li><strong>Infrastructure Deficits</strong>: Fewer street trees contribute to higher temperatures, while limited broadband access restricts economic opportunities</li>
      </ul>
    </div>

    <div class="call-to-action">
      <h3>Call to Action for San Jose Leaders</h3>
      <p>Targeted policies must address these historical inequities to break the cycle of inequality. We recommend:</p>
      <ol>
        <li>Prioritizing infrastructure investments in formerly redlined neighborhoods</li>
        <li>Implementing targeted broadband expansion programs in underserved areas</li>
        <li>Increasing green infrastructure and tree canopy in heat-vulnerable neighborhoods</li>
        <li>Developing housing policies that explicitly address historical disparities</li>
      </ol>
      <p>Explore the map to see how these patterns manifest in specific neighborhoods across San Jose.</p>
    </div>
  </div>

  <div class="polygon-content">
    <button id="back-to-overview">← Back to Overview</button>
    <h2 id="graphs-title">Select a polygon to view charts</h2>
    <div id="graphs-content">
      <p>Click a HOLC polygon on the map to populate these graphs and metrics.</p>
    </div>
  </div>
</div>
<div id="info">Hover a polygon</div>
<div class="legend" id="legend">
  <div style="font-weight:600; margin-bottom:6px;">HOLC grade</div>
  <div class="row"><span class="swatch" style="background:#2ca25f"></span>A</div>
  <div class="row"><span class="swatch" style="background:#1f78b4"></span>B</div>
  <div class="row"><span class="swatch" style="background:#f1c40f"></span>C</div>
  <div class="row"><span class="swatch" style="background:#e34a33"></span>D</div>
  <div class="row"><span class="swatch" style="background:#999999"></span>Other</div>
</div>
<div id="layer-controls">
  <label><input type="checkbox" id="toggle-holc" checked> HOLC Zones</label>
  <label><input type="checkbox" id="toggle-rail"> Rail</label>
  <label><input type="checkbox" id="toggle-light-rail"> Light Rail</label>
  <label><input type="checkbox" id="toggle-broadband"> Broadband Anchors</label>
</div>

<script>
  const TILEJSON_URL = "https://api.maptiler.com/tiles/01990763-49f0-77ce-b1b1-b97328f38e70/tiles.json?key=PrTVbrUk3PBatpAWhyvh";
  const FIELD_MAP = {
    grade: "grade",
    label: "label",
    median: "Median Housing Value",
    pct_white: "Percent White",
    pct_black: "Percent Black",
    pct_asian: "Percent Asian",
    pct_hisp: "Percent Hispanic",
    pct_native: "Percent Native American",
    broadband_anchors: "Broadband Anchors",
    street_trees: "Street Trees",
    rail_length: "Rail Length",
    light_rail_length: "Light Rail Length",
    broadband_served: "Broadband Percent Served",
    broadband_underserved: "Broadband Percent Underserved",
    broadband_priority: "Broadband Percent Priority Underserved"
  };

  function getMapped(props, fieldId) {
    if (!props || !FIELD_MAP[fieldId]) return null;
    const k = FIELD_MAP[fieldId];
    return props.hasOwnProperty(k) ? props[k] : null;
  }

  function parseNumberFlexible(v) {
    if (v === null || v === undefined) return null;
    if (typeof v === 'number' && Number.isFinite(v)) return v;
    const s = String(v).trim();
    if (s === '' || ['null','nan'].includes(s.toLowerCase())) return null;
    if (s.includes('%')) {
      const n = Number(s.replace(/[%\s,]/g,''));
      return Number.isFinite(n) ? n : null;
    }
    const n = Number(s.replace(/[$,\s]/g,''));
    if (!Number.isFinite(n)) return null;
    return n;
  }

  function parsePercent(val) {
    const num = parseNumberFlexible(val);
    if (num === null || isNaN(num)) return 0;
    return num;
  }

  function formatNumber(n) {
    return (n === null || isNaN(n)) ? 'N/A' : Number(n).toLocaleString(undefined, {maximumFractionDigits:0});
  }

  function miniInlineBar(label, pct, color) {
    const p = pct ? Math.max(0, Math.min(100, pct)) : 0;
    return `<div style="display:flex;align-items:center;margin:4px 0;">
                <div style="width:120px;font-size:12px">${label}</div>
                <div style="background:#eee;width:160px;height:10px;border-radius:4px;overflow:hidden;margin-left:8px">
                    <div style="width:${p}%;height:100%;background:${color};"></div>
                </div>
                <div style="min-width:46px;text-align:right;margin-left:8px;font-size:12px">${p.toFixed(1)}%</div>
            </div>`;
  }

  function largeBarRow(label, pct, color) {
    const p = pct ? Math.max(0, Math.min(100, pct)) : 0;
    return `<div class="bar-row">
                <div class="bar-label">${label}</div>
                <div class="bar-track"><div class="bar-fill" style="width:${p}%;background:${color}"></div></div>
                <div style="min-width:56px;text-align:right;font-weight:600">${p.toFixed(1)}%</div>
            </div>`;
  }

  function stackedSingleBarHtml(s,u,p,w=420) {
    const sum = (s||0)+(u||0)+(p||0);
    const ws = sum? (s/sum)*100:0, wu = sum? (u/sum)*100:0, wp = sum? (p/sum)*100:0;
    return `<div style="display:flex;align-items:center;gap:12px;margin:8px 0;">
                <div style="width:160px">Broadband</div>
                <div style="background:#eee;width:${w}px;height:18px;border-radius:4px;overflow:hidden;display:flex">
                    <div style="width:${ws}%;background:#2ca25f"></div>
                    <div style="width:${wu}%;background:#f1c40f"></div>
                    <div style="width:${wp}%;background:#e34a33"></div>
                </div>
                <div style="min-width:140px;text-align:right">${s.toFixed(1)}% served • ${u.toFixed(1)}% underserved • ${p.toFixed(1)}% priority</div>
            </div>`;
  }

  const tabMap = document.getElementById('tab-map');
  const tabGraphs = document.getElementById('tab-graphs');
  const mapEl = document.getElementById('map');
  const graphsEl = document.getElementById('graphs');
  const infoBox = document.getElementById('info');
  const legendEl = document.getElementById('legend');
  const layerControlsEl = document.getElementById('layer-controls');
  const overviewContent = document.querySelector('.overview-content');
  const polygonContent = document.querySelector('.polygon-content');
  const backToOverviewBtn = document.getElementById('back-to-overview');

  tabMap.onclick = () => {
    tabMap.classList.add('active');
    tabGraphs.classList.remove('active');
    mapEl.style.display = 'block';
    graphsEl.style.display = 'none';
    infoBox.style.display = 'block';
    legendEl.style.display = 'block';
    layerControlsEl.style.display = 'block';
    if(window._map) window._map.resize();
  };

  tabGraphs.onclick = () => {
    tabGraphs.classList.add('active');
    tabMap.classList.remove('active');
    mapEl.style.display = 'none';
    graphsEl.style.display = 'block';
    infoBox.style.display = 'none';
    legendEl.style.display = 'none';
    layerControlsEl.style.display = 'none';
  };

  backToOverviewBtn.onclick = () => {
    overviewContent.style.display = 'block';
    polygonContent.style.display = 'none';
  };

  async function init() {
    const tj = await (await fetch(TILEJSON_URL)).json();
    const sourceLayer = tj.vector_layers?.[0]?.id;
    const style = {
      version: 8,
      sources: {
        osm: {
          type: "raster",
          tiles: ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
          tileSize: 256
        },
        "holc-tiles": {
          type: "vector",
          url: TILEJSON_URL
        }
      },
      layers: [{
        id: 'osm',
        type: 'raster',
        source: 'osm'
      }]
    };

    const map = new maplibregl.Map({
      container: 'map',
      style,
      center: [-121.8863, 37.3382],
      zoom: 12
    });
    window._map = map;

    map.on('load', () => {
      // Add HOLC polygons
      map.addLayer({
        id: 'holc-fill',
        type: 'fill',
        source: 'holc-tiles',
        'source-layer': sourceLayer,
        paint: {
          'fill-color': [
            'match',
            ['get', 'grade'],
            'A', '#2ca25f',
            'B', '#1f78b4',
            'C', '#f1c40f',
            'D', '#e34a33',
            '#999'
          ],
          'fill-opacity': 0.65
        }
      });

      map.addLayer({
        id: 'holc-line',
        type: 'line',
        source: 'holc-tiles',
        'source-layer': sourceLayer,
        paint: {
          'line-color': '#222',
          'line-width': 1
        }
      });

      // Add infrastructure layers
      // Rail
      map.addSource('rail', {
        type: 'geojson',
        data: 'https://api.maptiler.com/data/01990e77-7d61-7687-8575-6e804eb532f6/features.json?key=PrTVbrUk3PBatpAWhyvh'
      });

      map.addLayer({
        id: 'rail-line',
        type: 'line',
        source: 'rail',
        layout: { visibility: 'none' },
        paint: {
          'line-color': '#000000',
          'line-width': 2,
          'line-dasharray': [2, 2]
        }
      });

      // Light Rail
      map.addSource('light-rail', {
        type: 'geojson',
        data: 'https://api.maptiler.com/data/0199215c-1501-7b68-9122-47e0167261d4/features.json?key=PrTVbrUk3PBatpAWhyvh'
      });

      map.addLayer({
        id: 'light-rail-line',
        type: 'line',
        source: 'light-rail',
        layout: { visibility: 'none' },
        paint: {
          'line-color': '#9b59b6',
          'line-width': 2,
        }
      });

      // Broadband Anchors
      map.addSource('broadband-anchors', {
        type: 'geojson',
        data: 'https://api.maptiler.com/data/01992159-807d-79ae-93a9-a66d86e84ca9/features.json?key=PrTVbrUk3PBatpAWhyvh'
      });

      map.addLayer({
        id: 'broadband-anchors-point',
        type: 'circle',
        source: 'broadband-anchors',
        layout: { visibility: 'none' },
        paint: {
          'circle-radius': 4,
          'circle-color': '#3498db',
          'circle-stroke-width': 1,
          'circle-stroke-color': '#fff'
        }
      });

      const popup = new maplibregl.Popup({
        closeButton: true,
        closeOnClick: true,
        maxWidth: '380px'
      });

      map.on('mousemove', 'holc-fill', e => {
        const props = e.features[0].properties;
        infoBox.innerHTML = `<strong>${getMapped(props, 'label') || 'Zone'}</strong><br/>Grade: ${getMapped(props, 'grade') || 'N/A'}`;
      });

      map.on('mouseleave', 'holc-fill', () => infoBox.innerText = 'Hover a polygon');

      map.on('click', 'holc-fill', e => {
        const props = e.features[0].properties;
        const grade = getMapped(props, 'grade'), label = getMapped(props, 'label');
        const median = parseNumberFlexible(getMapped(props, 'median'));
        const pctWhite = parseNumberFlexible(getMapped(props, 'pct_white'));
        const pctBlack = parseNumberFlexible(getMapped(props, 'pct_black'));
        const pctAsian = parseNumberFlexible(getMapped(props, 'pct_asian'));
        const pctHisp = parseNumberFlexible(getMapped(props, 'pct_hisp'));
        const pctNative = parseNumberFlexible(getMapped(props, 'pct_native'));
        const broadbandAnchors = parseNumberFlexible(getMapped(props, 'broadband_anchors'));
        const streetTrees = parseNumberFlexible(getMapped(props, 'street_trees'));
        const railLength = parseNumberFlexible(getMapped(props, 'rail_length')) || 0;
        const lightRailLength = parseNumberFlexible(getMapped(props, 'light_rail_length')) || 0;
        const bs = parsePercent(getMapped(props, 'broadband_served'));
        const bu = parsePercent(getMapped(props, 'broadband_underserved'));
        const bp = parsePercent(getMapped(props, 'broadband_priority'));

        let html = `<div class="popup-table"><div class="popup-scroll">
                        <div><span class="metric">Grade:</span> ${grade}<br/><span class="metric">Label:</span> ${label}</div>
                        <div><span class="metric">Median Housing Value:</span> ${median ? '$' + formatNumber(median) : 'N/A'}</div>
                        <div><strong>Race %</strong>
                            ${miniInlineBar('White', pctWhite, '#1f78b4')}
                            ${miniInlineBar('Black', pctBlack, '#6a3d9a')}
                            ${miniInlineBar('Asian', pctAsian, '#b15928')}
                            ${miniInlineBar('Hispanic', pctHisp, '#ff7f00')}
                            ${miniInlineBar('Native', pctNative, '#777')}
                        </div>
                        <div><strong>Counts</strong>
                            <div>Broadband Anchors: ${formatNumber(broadbandAnchors)}</div>
                            <div>Street Trees: ${formatNumber(streetTrees)}</div>
                            <div>Rail Length: ${railLength}</div>
                            <div>Light Rail Length: ${lightRailLength}</div>
                        </div>
                        <div><strong>Broadband %</strong>
                            ${stackedSingleBarHtml(bs || 0, bu || 0, bp || 0, 180)}
                        </div>
                    </div></div>`;

        popup.setLngLat(e.lngLat).setHTML(html).addTo(map);

        const graphsTitle = document.getElementById('graphs-title');
        const graphsContent = document.getElementById('graphs-content');
        graphsTitle.innerText = `${label} — Grade ${grade}`;

        let ghtml = `<div class="stat-grid">
                        <div class="stat-card"><div>Median Housing Value</div><div>$${formatNumber(median)}</div></div>
                        <div class="stat-card"><div>Broadband Anchors</div><div>${formatNumber(broadbandAnchors)}</div></div>
                        <div class="stat-card"><div>Street Trees</div><div>${formatNumber(streetTrees)}</div></div>
                        <div class="stat-card"><div>Rail Length</div><div>${railLength}</div></div>
                        <div class="stat-card"><div>Light Rail Length</div><div>${lightRailLength}</div></div>
                    </div>`;

        ghtml += `<div><div class="chart-title">Race composition</div>
                        ${largeBarRow('White', pctWhite, '#1f78b4')}
                        ${largeBarRow('Black', pctBlack, '#6a3d9a')}
                        ${largeBarRow('Asian', pctAsian, '#b15928')}
                        ${largeBarRow('Hispanic', pctHisp, '#ff7f00')}
                        ${largeBarRow('Native', pctNative, '#777')}
                    </div>`;

        ghtml += `<div><div class="chart-title">Broadband coverage</div>
                        ${stackedSingleBarHtml(bs || 0, bu || 0, bp || 0, 420)}
                    </div>`;

        graphsContent.innerHTML = ghtml;

        // Show polygon content and hide overview
        overviewContent.style.display = 'none';
        polygonContent.style.display = 'block';
      });

      // Layer toggles
      document.getElementById('toggle-holc').onchange = (e) => {
        const v = e.target.checked ? 'visible' : 'none';
        map.setLayoutProperty('holc-fill', 'visibility', v);
        map.setLayoutProperty('holc-line', 'visibility', v);
      };

      document.getElementById('toggle-rail').onchange = (e) => {
        const v = e.target.checked ? 'visible' : 'none';
        map.setLayoutProperty('rail-line', 'visibility', v);
      };

      document.getElementById('toggle-light-rail').onchange = (e) => {
        const v = e.target.checked ? 'visible' : 'none';
        map.setLayoutProperty('light-rail-line', 'visibility', v);
      };

      document.getElementById('toggle-broadband').onchange = (e) => {
        const v = e.target.checked ? 'visible' : 'none';
        map.setLayoutProperty('broadband-anchors-point', 'visibility', v);
      };
    });
  }

  init();
</script>
</body>
</html>