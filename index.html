<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>San Jose Redlining</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link href="https://unpkg.com/maplibre-gl@1.15.2/dist/maplibre-gl.css" rel="stylesheet"/>
  <script src="https://unpkg.com/maplibre-gl@1.15.2/dist/maplibre-gl.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      background-color: #f8f9fa;
      line-height: 1.6;
    }

    /* Header and Navigation */
    .header {
      background: linear-gradient(135deg, #1a2a6c, #2a4b8c);
      color: white;
      padding: 15px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      position: relative;
      z-index: 10;
    }

    .header h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
    }

    .tabs {
      display: flex;
      gap: 2px;
      background: #2a4b8c;
      padding: 0 10px;
      overflow-x: auto;
      white-space: nowrap;
      position: relative;
      z-index: 10;
    }

    .tab {
      padding: 12px 16px;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-weight: 500;
      transition: all 0.2s;
    }

    .tab:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .tab.active {
      background: white;
      color: #1a2a6c;
    }

    /* Main Content Areas */
    .content-section {
      display: none;
      position: absolute;
      top: 106px;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 20px;
      overflow-y: auto;
      background: white;
    }

    .content-section.active {
      display: block;
    }

    #map-container {
      padding: 0;
      overflow: hidden;
    }

    /* Map Elements */
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
    }

    .map-controls {
      position: absolute;
      top: 15px;
      right: 15px;
      z-index: 2;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .map-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: white;
      border: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Sidebar container that stacks controls */
    #sidebar {
      position: absolute;
      top: 60px;
      left: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 3;
      align-items: flex-start; /* left align children */
      max-width: 320px;
    }

    /* Layer controls (now non-absolute; will be stacked inside #sidebar) */
    #layer-controls {
      background: rgba(255, 255, 255, 0.95);
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      font-size: 13px;
      width: 100%;
    }

    #layer-controls label {
      display: block;
      margin-bottom: 6px;
      cursor: pointer;
    }

    /* Info box (stacked under layer-controls inside #sidebar) */
    #info {
      background: rgba(255, 255, 255, 0.95);
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      font-size: 14px;
      width: 100%;
      max-width: 320px;
      z-index: 2;
    }

    .legend {
      position: absolute;
      right: 15px;
      bottom: 30px;
      background: rgba(255, 255, 255, 0.95);
      padding: 12px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 2;
      font-size: 13px;
    }

    .swatch {
      width: 18px;
      height: 12px;
      border-radius: 2px;
      border: 1px solid rgba(0,0,0,0.08);
      display: inline-block;
      margin-right: 8px;
      vertical-align: middle;
    }

    .legend .row {
      margin-bottom: 6px;
    }

    /* Popup Styles */
    .popup-table {
      font-size: 13px;
      line-height: 1.4;
      max-width: 340px;
    }

    .popup-scroll {
      max-height: 300px;
      overflow: auto;
      padding-right: 8px;
    }

    .metric {
      font-weight: 600;
      margin-right: 6px;
    }

    .fullscreen-btn {
      background: none;
      border: none;
      color: #1a2a6c;
      cursor: pointer;
      font-size: 14px;
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 1000;
      overflow-y: auto;
      padding: 40px 20px;
    }

    .modal-content {
      background: white;
      max-width: 800px;
      margin: 0 auto;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 5px 25px rgba(0,0,0,0.3);
      position: relative;
    }

    .close-modal {
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      color: #666;
    }

    /* Content Styles */
    .content-card {
      background: white;
      border-radius: 8px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .content-card h2 {
      margin-top: 0;
      color: #1a2a6c;
      border-bottom: 2px solid #f1c40f;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }

    .content-card h3 {
      color: #2a4b8c;
      margin-top: 25px;
      margin-bottom: 15px;
    }

    .content-card h4 {
      color: #2a4b8c;
      margin-top: 20px;
      margin-bottom: 10px;
    }

    .info-box {
      background: #f8f9fa;
      border-left: 4px solid #1a2a6c;
      padding: 15px;
      margin: 20px 0;
    }

    .policy-box {
      background: #f8f9fa;
      padding: 15px;
      margin: 20px 0;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    .chart-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }

    .chart-container {
      width: 100%;
      margin: 15px 0;
      border: 1px solid #ddd;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-radius: 4px;
      overflow: hidden;
      display: flex;
      justify-content: center;
    }

    .responsive-iframe {
      width: 100%;
      height: 350px;
      border: none;
    }

    /* Circles Visualization */
    .circles-vis {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 400px;
      position: relative;
      margin: 40px 0;
    }

    .central-circle {
      width: 160px;
      height: 160px;
      fill-opacity: 0.7;
      border-radius: 50%;
      background: #3b446c;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      text-align: center;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      z-index: 0;
      position: absolute;
    }

    .satellite-circle {
      position: absolute;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      text-align: center;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      cursor: pointer;
      transition: all 0.3s;
      z-index: 1;
    }

    .satellite-circle:hover {
      transform: scale(1.05);
    }

    .circle-modal-content {
      padding: 20px;
    }

    .circle-modal-content h3 {
      color: #1a2a6c;
      margin-top: 0;
      border-bottom: 2px solid #f1c40f;
      padding-bottom: 10px;
    }

    /* Contact Form */
    .contact-form {
      max-width: 100%;
      margin: 0 auto;
    }

    .google-form-container {
      width: 100%;
      height: 664px;
      border: none;
      margin: 20px 0;
    }

    .submit-btn {
      background: #1a2a6c;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 4px;
      font-weight: 600;
      cursor: pointer;
    }

    /* Help Button */
    .help-btn {
      position: absolute;
      bottom: 15px;
      left: 15px;
      z-index: 2;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: white;
      border: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Home Button */
    .home-btn {
      position: absolute;
      top: 110px;
      right: 15px;
      z-index: 2;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: white;
      border: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .tabs {
        padding-bottom: 5px;
      }

      .tab {
        padding: 10px 12px;
        font-size: 14px;
      }

      .chart-grid {
        grid-template-columns: 1fr;
      }

      .responsive-iframe {
        height: 300px;
      }

      .circles-vis {
        height: 350px;
      }

      .central-circle {
        width: 120px;
        height: 120px;
        font-size: 14px;
      }

      .satellite-circle {
        padding: 15px;
        font-size: 12px;
      }

      .content-section {
        top: 96px;
        padding: 15px;
        padding-top: 30px; /* Added more top padding for mobile */
      }

      .content-card {
        padding: 15px;
      }

      .content-card h2 {
        margin-top: 0;
        font-size: 1.5rem;
        padding-top: 5px;
        margin-bottom: 15px;
      }

      .map-controls {
        top: 70px;
        right: 10px;
        flex-direction: row; /* Change to row layout on mobile */
        gap: 5px;
      }

      .map-btn {
        width: 32px;
        height: 32px;
        font-size: 16px;
      }

      .home-btn {
        top: 70px;
        right: 110px; /* Position to left of zoom controls */
        width: 32px;
        height: 32px;
        font-size: 16px;
      }

      /* Sidebar adjustments for mobile */
      #sidebar {
        top: 50px;
        left: 10px;
        gap: 8px;
        max-width: 240px;
      }

      #info {
        max-width: 240px;
        font-size: 13px;
        padding: 8px;
      }

      #layer-controls {
        padding: 8px;
        font-size: 13px;
      }

      .google-form-container {
        height: 800px;
      }
    }

    /* Extra small devices */
    @media (max-width: 480px) {
      .home-btn {
        right: 100px; /* Adjust for very small screens */
      }

      .content-section {
        padding-top: 35px; /* Even more padding for very small screens */
      }

      #sidebar {
        left: 8px;
        top: 48px;
        max-width: 200px;
      }

      #info {
        max-width: 200px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
<!-- Header with Title -->
<div class="header">
  <h1>Tracing the Long-Term Consequences of Redlining in San Jose</h1>
</div>

<!-- Navigation Tabs -->
<div class="tabs">
  <div id="tab-map" class="tab active">Map</div>
  <div id="tab-redlining" class="tab">What is Redlining</div>
  <div id="tab-methodology" class="tab">Study Methodology</div>
  <div id="tab-graphs" class="tab">Findings</div>
  <div id="tab-policy" class="tab">Policy Implications</div>
  <div id="tab-contact" class="tab">Contact</div>
</div>

<!-- Map Section -->
<div id="map-container" class="content-section active">
  <div id="map"></div>

  <!-- Map Controls -->
  <div class="map-controls">
    <button class="map-btn" id="zoom-in">+</button>
    <button class="map-btn" id="zoom-out">-</button>
  </div>

  <button class="home-btn" id="home-btn">
    <i class="fas fa-home"></i>
  </button>

  <!-- Sidebar: stacks layer controls and info box -->
  <div id="sidebar">
    <div id="layer-controls">
      <label><input type="checkbox" id="toggle-holc" checked> HOLC Zones</label>
      <label><input type="checkbox" id="toggle-no2"> NO₂ Levels</label>  <!-- ADD THIS LINE -->
      <label><input type="checkbox" id="toggle-rail"> Rail</label>
      <label><input type="checkbox" id="toggle-light-rail"> Light Rail</label>
      <label><input type="checkbox" id="toggle-broadband"> Broadband Anchors</label>
      <label><input type="checkbox" id="toggle-dacs"> DACs</label>
    </div>

    <div id="info">Click on a zone for more info</div>
  </div>

  <button class="help-btn" id="help-btn">
    <i class="fas fa-question"></i>
  </button>

  <div class="legend" id="legend">
    <div style="font-weight:600; margin-bottom:8px;">HOLC Grade</div>
    <div class="row"><span class="swatch" style="background:#2ca25f"></span>A - Best</div>
    <div class="row"><span class="swatch" style="background:#1f78b4"></span>B - Still Desirable</div>
    <div class="row"><span class="swatch" style="background:#f1c40f"></span>C - Declining</div>
    <div class="row"><span class="swatch" style="background:#e34a33"></span>D - Hazardous</div>
    <!-- Add this right after the D - Hazardous line, before closing </div> of legend -->
    <div id="no2-legend" style="display:none; margin-top:16px; padding-top:12px; border-top:1px solid #ddd;">
      <div style="font-weight:600; margin-bottom:8px;">NO₂ Concentration</div>
      <div style="width:100%; height:20px; background:linear-gradient(to right, #2ca25f, #f1c40f, #e34a33); border-radius:3px; margin:8px 0;"></div>
      <div style="display:flex; justify-content:space-between; font-size:11px; color:#666;">
        <span>Low</span>
        <span>High</span>
      </div>
      <div style="font-size:10px; color:#666; margin-top:4px;">molecules/cm²</div>
    </div>
  </div>
</div>

<!-- What is Redlining Section -->
<div id="redlining-content" class="content-section">
  <div class="content-card">
    <h2>What is Redlining?</h2>
    <p>Redlining was a discriminatory practice that began in the 1930s when the federal government's Home Owners' Loan Corporation (HOLC) created maps of American cities to assess lending risk. These maps color-coded neighborhoods based on their perceived creditworthiness:</p>

    <div class="info-box">
      <div style="display: flex; align-items: center; gap: 15px; margin: 10px 0; flex-wrap: wrap;">
        <div style="display: flex; align-items: center;">
          <span class="swatch" style="background:#2ca25f; margin-right: 8px;"></span>
          <span><strong>A (Green)</strong> - "Best"</span>
        </div>
        <div style="display: flex; align-items: center;">
          <span class="swatch" style="background:#1f78b4; margin-right: 8px;"></span>
          <span><strong>B (Blue)</strong> - "Still Desirable"</span>
        </div>
        <div style="display: flex; align-items: center;">
          <span class="swatch" style="background:#f1c40f; margin-right: 8px;"></span>
          <span><strong>C (Yellow)</strong> - "Declining"</span>
        </div>
        <div style="display: flex; align-items: center;">
          <span class="swatch" style="background:#e34a33; margin-right: 8px;"></span>
          <span><strong>D (Red)</strong> - "Hazardous"</strong></span>
        </div>
      </div>
    </div>

    <p>Neighborhoods with predominantly Black, Hispanic, immigrant, or Jewish residents were typically marked in red (D zones) and denied home loans and other financial services, regardless of individual residents' creditworthiness.</p>

    <h3>Impact on San Jose</h3>
    <p>In San Jose, redlining practices systematically disadvantaged communities of color, creating patterns of disinvestment that continue to affect these neighborhoods today. The historically redlined areas correlate strongly with current patterns of inequality in infrastructure, housing values, and opportunity.</p>

    <div class="info-box">
      <p><strong>Historical Context:</strong> This discriminatory practice lasted for decades and was only officially outlawed with the passage of the Fair Housing Act in 1968. However, the legacy of redlining continues to shape American cities, including San Jose.</p>
    </div>
  </div>
</div>

<!-- Study Methodology Section -->
<div id="methodology-content" class="content-section">
  <div class="content-card">
    <h2>Study Methodology</h2>
    <p>This research examines the lasting impacts of historical redlining practices on contemporary neighborhood characteristics in San Jose, California, using GIS and geospatial analysis.</p>

    <div class="info-box">
      <h3>Research Question</h3>
      <p>How does historical redlining continue to impact public infrastructure and neighborhood characteristics in San Jose?</p>
    </div>

    <h3>Data Sources</h3>
    <div class="chart-grid">
      <div>
        <h4>Historical Data</h4>
        <ul>
          <li><strong>Redlining Maps:</strong> Digitized HOLC maps from University of Richmond's "Mapping Inequality" project</li>
          <li><strong>Historical Context:</strong> HOLC area descriptions and risk assessments</li>
        </ul>
      </div>
      <div>
        <h4>Contemporary Data</h4>
        <ul>
          <li><strong>Demographic Data:</strong> U.S. Census Bureau American Community Survey</li>
          <li><strong>Infrastructure Data:</strong> City of San Jose open data, OpenStreetMap</li>
          <li><strong>Property Values:</strong> Zillow Home Value Index and county records</li>
        </ul>
      </div>
    </div>

    <h3>Analytical Approach</h3>
    <p>The study employed Geographic Information Systems (GIS) to overlay historical redlining maps with contemporary data. QGIS was used to perform spatial analysis including:</p>

    <div class="chart-grid">
      <div>
        <h4>Spatial Analysis</h4>
        <ul>
          <li>Geographic overlay of historical HOLC zones</li>
          <li>Spatial joins to aggregate contemporary data</li>
          <li>Buffer analysis for infrastructure distribution</li>
          <li>Comparative analysis across HOLC grades</li>
        </ul>
      </div>
      <div>
        <h4>Statistical Methods</h4>
        <ul>
          <li>Descriptive statistics for each HOLC grade</li>
          <li>Comparative analysis of infrastructure distribution</li>
          <li>Correlation analysis between historical grades and current conditions</li>
        </ul>
      </div>
    </div>

    <h3>Variables Analyzed</h3>
    <p>The research examined multiple dimensions of neighborhood inequality across historical HOLC grades:</p>

    <div class="chart-grid">
      <div>
        <h4>Infrastructure Metrics</h4>
        <ul>
          <li>Broadband internet access points</li>
          <li>Street trees per square kilometer</li>
          <li>Rail and light rail infrastructure</li>
          <li>Public transportation access</li>
        </ul>
      </div>
      <div>
        <h4>Demographic & Economic</h4>
        <ul>
          <li>Racial and ethnic composition</li>
          <li>Median housing values</li>
          <li>Homeownership rates</li>
          <li>Income levels and poverty rates</li>
        </ul>
      </div>
    </div>

    <div class="info-box">
      <h3>Key Findings from Analysis</h3>
      <p>The analysis revealed clear disparities in infrastructure investment and neighborhood characteristics that correlate strongly with historical redlining grades, with formerly redlined areas (Grades C & D) showing significantly lower levels of positive infrastructure and higher levels of negative infrastructure.</p>
    </div>
  </div>
</div>

<!-- Graphs & Results Section -->
<div id="graphs-content" class="content-section">
  <div class="content-card">
    <h2>Findings</h2>
    <div class="policy-box">
      <h3>Summary</h3>
      <ul>
        <li><strong>Disinvestment:</strong> Formerly redlined areas have the lowest median housing values, reducing tax revenue and limiting infrastructure funding</li>
        <li><strong>Persistent Racial Disparities:</strong> These areas still have higher concentrations of Hispanic and Black residents, reflecting lasting segregation</li>
        <li><strong>Infrastructure Deficits:</strong> Fewer street trees contribute to higher temperatures, while limited broadband access restricts economic opportunities</li>
        <li><strong>Environmental Burdens:</strong> Historically redlined areas have more exposure to pollution sources and less access to green space</li>
      </ul>
    </div>
    <h3><strong>Click on the circles below to learn more about each dimension of inequality.</strong></h3>


    <!-- Updated Circles Visualization with Central Circle -->
    <div class="circles-vis">
      <div class="satellite-circle" style="width: 130px; height: 130px; background: rgba(66, 133, 244, 0.7); top: 50px; left: calc(50% - 160px);" data-category="broadband">
        Broadband Access
      </div>
      <div class="satellite-circle" style="width: 130px; height: 130px; background: rgba(52, 168, 83, 0.7); top: 50px; right: calc(50% - 160px);" data-category="green">
        Green Infrastructure
      </div>
      <div class="satellite-circle" style="width: 130px; height: 130px; background: rgba(251, 188, 5, 0.7); bottom: 50px; left: calc(50% - 160px);" data-category="housing">
        Housing Values
      </div>
      <div class="satellite-circle" style="width: 130px; height: 130px; background: rgba(234, 67, 53, 0.7); bottom: 50px; right: calc(50% - 160px);" data-category="demographics">
        Racial Demographics
      </div>
      <div class="central-circle">
        Redlining Impact Analysis
      </div>
    </div>
  </div>
</div>

<!-- Policy Implications Section -->
<div id="policy-content" class="content-section">
  <div class="content-card">
    <h2>Policy Implications</h2>
    <p>The research findings demonstrate that historical redlining continues to shape contemporary inequality in San Jose. Addressing these disparities requires targeted policy interventions.</p>

    <h3>Policy Recommendations</h3>

    <div class="chart-grid">
      <div>
        <div class="policy-box">
          <h4>Housing & Economic Justice</h4>
          <ul>
            <li>Implement targeted down payment assistance programs in historically redlined areas</li>
            <li>Create community land trusts to preserve affordable housing</li>
            <li>Expand property tax relief programs for long-term residents</li>
            <li>Incentivize community-owned businesses and cooperatives</li>
          </ul>
        </div>
      </div>

      <div>
        <div class="policy-box">
          <h4>Infrastructure Investment</h4>
          <ul>
            <li>Prioritize broadband infrastructure expansion in underserved neighborhoods</li>
            <li>Increase tree planting and green space in heat-vulnerable areas</li>
            <li>Improve public transportation connections to opportunity areas</li>
            <li>Invest in community facilities like libraries and recreation centers</li>
          </ul>
        </div>
      </div>

      <div>
        <div class="policy-box">
          <h4>Health & Environmental Equity</h4>
          <ul>
            <li>Address urban heat island effects through cool pavement and roof initiatives</li>
            <li>Reduce pollution exposure through buffer zones and emissions controls</li>
            <li>Increase access to healthy food options in food deserts</li>
            <li>Expand health services in medically underserved areas</li>
          </ul>
        </div>
      </div>

      <div>
        <div class="policy-box">
          <h4>Community Engagement & Reparative Justice</h4>
          <ul>
            <li>Create community oversight boards for development decisions</li>
            <li>Implement participatory budgeting processes</li>
            <li>Support cultural preservation and community history projects</li>
            <li>Establish truth and reconciliation processes around housing discrimination</li>
          </ul>
        </div>
      </div>
    </div>

    <h3>Call to Action for San Jose Leaders</h3>
    <p>Targeted policies must address these historical inequities to break the cycle of inequality. We recommend creating a comprehensive Reparative Infrastructure Plan that:</p>

    <ol>
      <li>Prioritizes investment in historically marginalized neighborhoods</li>
      <li>Creates mechanisms for community control over development decisions</li>
      <li>Addresses both material disparities and historical trauma</li>
      <li>Establishes accountability measures to track progress</li>
    </ol>

    <div class="policy-box">
      <p>By consciously addressing the legacy of redlining, San Jose can become a more equitable and just city for all residents.</p>
    </div>
  </div>
</div>

<!-- Contact Section -->
<div id="contact-content" class="content-section">
  <div class="content-card">
    <h2>Contact</h2>
    <p>We welcome your questions, comments, and feedback about this research on the lasting impacts of redlining in San Jose.</p>

    <div class="contact-form">
      <iframe src="https://docs.google.com/forms/d/e/1FAIpQLScMi683vX3unkqJ88EshU_8aypCe3Dg_pIobZnm5C_XM5S_Dg/viewform?embedded=true" class="google-form-container">Loading…</iframe>
    </div>

    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee;">
      <h3>Additional Information</h3>
      <p><strong>Researcher:</strong> Aditya Rajesh</p>
      <p><strong>Email:</strong> <a href = "mailto:the.aditya.rajesh@gmail.com" target="_blank">the.aditya.rajesh@gmail.com</a></p>
      <p><strong>Linkedin:</strong> <a href="https://www.linkedin.com/in/aditya-rajesh-5815842a9/" target="_blank">Click here</a></p>
    </div>
  </div>
</div>

<!-- Tutorial Modal (UPDATED) -->
<div id="tutorial-modal" class="modal">
  <div class="modal-content">
    <span class="close-modal">&times;</span>

    <h2 style="margin-top:0;">Website Quick Guide</h2>

    <!-- Short intro moved directly under heading -->
    <p style="margin-top:6px; margin-bottom:18px; font-size:14px; color:#333;">
      This interactive map shows how historical redlining practices continue to affect San José neighborhoods today.
    </p>

    <!-- How to use the map: intentionally placed grid -->
    <h3 style="margin-bottom:10px;">How to Use the Map</h3>

    <div style="display:grid; grid-template-columns: 1fr 1fr; grid-template-rows: repeat(2, auto); grid-gap:12px;
                grid-template-areas: 'click zoom' 'hover layers'; margin-bottom:18px;">
      <!-- Click card (left-top) -->
      <div style="grid-area: click; display:flex; gap:12px; align-items:flex-start; padding:14px; border-radius:10px;
                  background:#fff; box-shadow:0 6px 18px rgba(10,20,40,0.06);">
        <div style="flex:0 0 52px; height:52px; display:flex; align-items:center; justify-content:center;
                    border-radius:10px; background:#1a2a6c; color:white; font-size:20px;">
          <i class="fas fa-mouse-pointer" aria-hidden="true"></i>
        </div>
        <div>
          <div style="font-weight:700; margin-bottom:6px;">Click a zone</div>
          <div style="font-size:13px; color:#444;">Click any colored zone to open a popup with detailed metrics and charts for that area.</div>
        </div>
      </div>

      <!-- Zoom & Home (right-top) -->
      <div style="grid-area: zoom; display:flex; gap:12px; align-items:flex-start; padding:14px; border-radius:10px;
                  background:#fff; box-shadow:0 6px 18px rgba(10,20,40,0.06);">
        <div style="flex:0 0 52px; height:52px; display:flex; align-items:center; justify-content:center;
                    border-radius:10px; background:#f1c40f; color:white; font-size:20px;">
          <i class="fas fa-search-plus" aria-hidden="true"></i>
        </div>
        <div>
          <div style="font-weight:700; margin-bottom:6px;">Zoom & Home</div>
          <div style="font-size:13px; color:#444;">
            Use the <strong>+</strong> / <strong>−</strong> buttons to zoom in/out. Click the <strong>Home</strong> button (house icon) to reset the map to the city center.
          </div>
        </div>
      </div>

      <!-- Hover (left-bottom) -->
      <div style="grid-area: hover; display:flex; gap:12px; align-items:flex-start; padding:14px; border-radius:10px;
                  background:#fff; box-shadow:0 6px 18px rgba(10,20,40,0.06);">
        <div style="flex:0 0 52px; height:52px; display:flex; align-items:center; justify-content:center;
                    border-radius:10px; background:#2a4b8c; color:white; font-size:20px;">
          <i class="fas fa-info-circle" aria-hidden="true"></i>
        </div>
        <div>
          <div style="font-weight:700; margin-bottom:6px;">Hover for quick info</div>
          <div style="font-size:13px; color:#444;">Hovering over a zone updates the small info panel — a fast way to compare areas without clicking.</div>
        </div>
      </div>

      <!-- Layers (right-bottom) -->
      <div style="grid-area: layers; display:flex; gap:12px; align-items:flex-start; padding:14px; border-radius:10px;
                  background:#fff; box-shadow:0 6px 18px rgba(10,20,40,0.06);">
        <div style="flex:0 0 52px; height:52px; display:flex; align-items:center; justify-content:center;
                    border-radius:10px; background:#4CAF50; color:white; font-size:20px;">
          <i class="fas fa-layer-group" aria-hidden="true"></i>
        </div>
        <div>
          <div style="font-weight:700; margin-bottom:6px;">Toggle layers</div>
          <div style="font-size:13px; color:#444;">Use the layer controls to toggle HOLC zones, rail, light rail, and broadband anchors for different comparisons.</div>
        </div>
      </div>
    </div>

    <!-- Explore Further: tab-focused simple guide (different formatting) -->
    <h3 style="margin-bottom:8px;">Explore Further (use the tabs above)</h3>
    <div style="padding:12px 14px; border-radius:8px; background:#f7fbff; border:1px solid #e6f0fb; color:#123;">
      <p style="margin:0 0 8px 0; font-size:14px;">
        Use the tabs at the top of the page to navigate the site. Each tab focuses on a different part of the research:
      </p>

      <ul style="margin:6px 0 0 20px; font-size:13px; color:#234;">
        <li style="margin-bottom:6px;"><strong>Map</strong> — Interactive map with HOLC overlays and infrastructure layers (default view).</li>
        <li style="margin-bottom:6px;"><strong>What is Redlining</strong> — Short historical background and glossary to help understand the map.</li>
        <li style="margin-bottom:6px;"><strong>Study Methodology</strong> — Data sources, GIS methods, and how metrics were computed.</li>
        <li style="margin-bottom:6px;"><strong>Findings</strong> — Visual summaries and interactive charts of key findings (click the circles to open details).</li>
        <li style="margin-bottom:6px;"><strong>Policy Implications</strong> — Short, actionable recommendations for equitable investment in San José.</li>
        <li style="margin-bottom:6px;"><strong>Contact</strong> — Embedded form and contact info for follow-ups or collaboration.</li>
      </ul>
    </div>

    <div style="text-align:center; margin-top:18px;">
      <button class="submit-btn" id="start-exploring">Start Exploring</button>
    </div>
  </div>
</div>



<!-- Fullscreen Details Modal -->
<div id="fullscreen-modal" class="modal">
  <div class="modal-content">
    <span class="close-modal" onclick="closeFullscreenModal()">&times;</span>
    <div id="fullscreen-content"></div>
  </div>
</div>

<!-- Circle Modal for Graphs -->
<div id="circle-modal" class="modal">
  <div class="modal-content">
    <span class="close-modal" onclick="closeCircleModal()">&times;</span>
    <div id="circle-modal-content" class="circle-modal-content"></div>
  </div>
</div>

<script>
  const TILEJSON_URL = "https://api.maptiler.com/tiles/01990763-49f0-77ce-b1b1-b97328f38e70/tiles.json?key=PrTVbrUk3PBatpAWhyvh";
  const FIELD_MAP = {
    grade: "grade",
    label: "label",
    median: "Median Housing Value",
    pct_white: "Percent White",
    pct_black: "Percent Black",
    pct_asian: "Percent Asian",
    pct_hisp: "Percent Hispanic",
    pct_native: "Percent Native American",
    broadband_anchors: "Broadband Anchors",
    street_trees: "Street Trees",
    rail_length: "Rail Length",
    light_rail_length: "Light Rail Length",
    broadband_served: "Broadband Percent Served",
    broadband_underserved: "Broadband Percent Underserved",
    broadband_priority: "Broadband Percent Priority Underserved"
  };

  // Tab Management
  const tabs = document.querySelectorAll('.tab');
  const contentSections = document.querySelectorAll('.content-section');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      // Remove active class from all tabs and sections
      tabs.forEach(t => t.classList.remove('active'));
      contentSections.forEach(s => s.classList.remove('active'));

      // Add active class to clicked tab
      tab.classList.add('active');

      // Show corresponding content section
      const tabId = tab.id;
      if (tabId === 'tab-map') {
        document.getElementById('map-container').classList.add('active');
        if (window._map) window._map.resize();
      } else if (tabId === 'tab-redlining') {
        document.getElementById('redlining-content').classList.add('active');
      } else if (tabId === 'tab-methodology') {
        document.getElementById('methodology-content').classList.add('active');
      } else if (tabId === 'tab-graphs') {
        document.getElementById('graphs-content').classList.add('active');
      } else if (tabId === 'tab-policy') {
        document.getElementById('policy-content').classList.add('active');
      } else if (tabId === 'tab-contact') {
        document.getElementById('contact-content').classList.add('active');
      }
    });
  });

  // Tutorial Modal
  const tutorialModal = document.getElementById('tutorial-modal');
  const closeModal = document.querySelectorAll('.close-modal');
  const startExploringBtn = document.getElementById('start-exploring');
  const helpBtn = document.getElementById('help-btn');

  // Show modal on page load
  window.addEventListener('load', () => {
    tutorialModal.style.display = 'block';
  });

  // Show modal when help button is clicked
  helpBtn.addEventListener('click', () => {
    tutorialModal.style.display = 'block';
  });

  closeModal.forEach(btn => {
    btn.addEventListener('click', () => {
      tutorialModal.style.display = 'none';
      document.getElementById('fullscreen-modal').style.display = 'none';
      document.getElementById('circle-modal').style.display = 'none';
    });
  });

  startExploringBtn.addEventListener('click', () => {
    tutorialModal.style.display = 'none';
  });

  // Circles interaction for Graphs & Results
  const circles = document.querySelectorAll('.satellite-circle');

  circles.forEach(circle => {
    circle.addEventListener('click', () => {
      const category = circle.getAttribute('data-category');
      showCircleModal(category);
    });
  });

  function showCircleModal(category) {
    const modal = document.getElementById('circle-modal');
    const content = document.getElementById('circle-modal-content');

    let html = '';

    switch(category) {
      case 'broadband':
        html = `<h3>Broadband Access Disparities</h3>
                <div class="chart-container">
                  <iframe class="responsive-iframe" seamless frameborder="0" scrolling="no" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRg1FjbeS85-cFpzGsRdobMtjb_Iu-JJJDjllgzePXZXgnHbJYPX94m5tHMcTfh2ebHqLBUT15gZWRM/pubchart?oid=280698462&amp;format=interactive"></iframe>
                </div>
                <p>Historically redlined areas (Grades C & D) have significantly fewer broadband anchors per square kilometer, limiting digital access and economic opportunities.</p>`;
        break;
      case 'green':
        html = `<h3>Green Infrastructure Disparities</h3>
                <div class="chart-container">
                  <iframe class="responsive-iframe" seamless frameborder="0" scrolling="no" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRg1FjbeS85-cFpzGsRdobMtjb_Iu-JJJDjllgzePXZXgnHbJYPX94m5tHMcTfh2ebHqLBUT15gZWRM/pubchart?oid=1010210670&amp;format=interactive"></iframe>
                </div>
                <div class="chart-container">
                  <iframe class="responsive-iframe" seamless frameborder="0" scrolling="no" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRg1FjbeS85-cFpzGsRdobMtjb_Iu-JJJDjllgzePXZXgnHbJYPX94m5tHMcTfh2ebHqLBUT15gZWRM/pubchart?oid=539685908&amp;format=interactive"></iframe>
                </div>
                <p>Neighborhoods graded D have far fewer street trees, contributing to urban heat island effects and reduced quality of life. Furthermore, there is significantly more rail, leading to noise and air pollution, detrimental for the health of citizens.</p>`;
        break;
      case 'housing':
        html = `<h3>Housing Value Disparities</h3>
                <div class="chart-container">
                  <iframe class="responsive-iframe" seamless frameborder="0" scrolling="no" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRg1FjbeS85-cFpzGsRdobMtjb_Iu-JJJDjllgzePXZXgnHbJYPX94m5tHMcTfh2ebHqLBUT15gZWRM/pubchart?oid=1395206384&amp;format=interactive"></iframe>
                </div>
                <p>The legacy of redlining is clearly visible in current housing values, with formerly redlined areas having significantly lower median values.</p>`;
        break;
      case 'demographics':
        html = `<h3>Racial Demographic Patterns</h3>
                <div class="chart-container">
                  <iframe class="responsive-iframe" seamless frameborder="0" scrolling="no" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRg1FjbeS85-cFpzGsRdobMtjb_Iu-JJJDjllgzePXZXgnHbJYPX94m5tHMcTfh2ebHqLBUT15gZWRM/pubchart?oid=134847115&amp;format=interactive"></iframe>
                </div>
                <p>Historical patterns of segregation persist, with formerly redlined areas still having higher concentrations of Hispanic and Black residents.</p>`;
        break;
    }

    content.innerHTML = html;
    modal.style.display = 'block';
  }

  function closeCircleModal() {
    document.getElementById('circle-modal').style.display = 'none';
  }

  // Fullscreen details modal functions
  function showFullscreenDetails(props) {
    const modal = document.getElementById('fullscreen-modal');
    const content = document.getElementById('fullscreen-content');

    const grade = getMapped(props, 'grade'), label = getMapped(props, 'label');
    const median = parseNumberFlexible(getMapped(props, 'median'));
    const pctWhite = parseNumberFlexible(getMapped(props, 'pct_white'));
    const pctBlack = parseNumberFlexible(getMapped(props, 'pct_black'));
    const pctAsian = parseNumberFlexible(getMapped(props, 'pct_asian'));
    const pctHisp = parseNumberFlexible(getMapped(props, 'pct_hisp'));
    const pctNative = parseNumberFlexible(getMapped(props, 'pct_native'));
    const broadbandAnchors = parseNumberFlexible(getMapped(props, 'broadband_anchors'));
    const streetTrees = parseNumberFlexible(getMapped(props, 'street_trees'));
    const railLength = parseNumberFlexible(getMapped(props, 'rail_length')) || 0;
    const lightRailLength = parseNumberFlexible(getMapped(props, 'light_rail_length')) || 0;
    const bs = parsePercent(getMapped(props, 'broadband_served'));
    const bu = parsePercent(getMapped(props, 'broadband_underserved'));
    const bp = parsePercent(getMapped(props, 'broadband_priority'));

    let html = `<h2>Zone Details: ${label} (Grade ${grade})</h2>
                <div class="popup-table">
                  <div><span class="metric">Median Housing Value:</span> ${median ? '$' + formatNumber(median) : 'N/A'}</div>
                  <h3>Demographic Composition</h3>
                  ${largeBarRow('White', pctWhite, '#1f78b4')}
                  ${largeBarRow('Black', pctBlack, '#6a3d9a')}
                  ${largeBarRow('Asian', pctAsian, '#b15928')}
                  ${largeBarRow('Hispanic', pctHisp, '#ff7f00')}
                  ${largeBarRow('Native American', pctNative, '#777')}
                  <h3>Infrastructure Metrics</h3>
                  <div>Broadband Anchors: ${formatNumber(broadbandAnchors)}</div>
                  <div>Street Trees: ${formatNumber(streetTrees)}</div>
                  <div>Rail Length: ${railLength.toFixed(1)} km</div>
                  <div>Light Rail Length: ${lightRailLength.toFixed(1)} km</div>
                  <h3>Broadband Access</h3>
                  ${stackedSingleBarHtml(bs || 0, bu || 0, bp || 0, 420)}
                </div>`;

    content.innerHTML = html;
    modal.style.display = 'block';
  }

  function closeFullscreenModal() {
    document.getElementById('fullscreen-modal').style.display = 'none';
  }

  // Map functions
  function getMapped(props, fieldId) {
    if (!props || !FIELD_MAP[fieldId]) return null;
    const k = FIELD_MAP[fieldId];
    return props.hasOwnProperty(k) ? props[k] : null;
  }

  function parseNumberFlexible(v) {
    if (v === null || v === undefined) return null;
    if (typeof v === 'number' && Number.isFinite(v)) return v;
    const s = String(v).trim();
    if (s === '' || ['null','nan'].includes(s.toLowerCase())) return null;
    if (s.includes('%')) {
      const n = Number(s.replace(/[%\s,]/g,''));
      return Number.isFinite(n) ? n : null;
    }
    const n = Number(s.replace(/[$,\s]/g,''));
    if (!Number.isFinite(n)) return null;
    return n;
  }

  function parsePercent(val) {
    const num = parseNumberFlexible(val);
    if (num === null || isNaN(num)) return 0;
    return num;
  }

  function formatNumber(n) {
    return (n === null || isNaN(n)) ? 'N/A' : Number(n).toLocaleString(undefined, {maximumFractionDigits:0});
  }

  function miniInlineBar(label, pct, color) {
    const p = pct ? Math.max(0, Math.min(100, pct)) : 0;
    return `<div style="display:flex;align-items:center;margin:4px 0;">
                  <div style="width:120px;font-size:12px">${label}</div>
                  <div style="background:#eee;width:160px;height:10px;border-radius:4px;overflow:hidden;margin-left:8px">
                      <div style="width:${p}%;height:100%;background:${color};"></div>
                  </div>
                  <div style="min-width:46px;text-align:right;margin-left:8px;font-size:12px">${p.toFixed(1)}%</div>
              </div>`;
  }

  function largeBarRow(label, pct, color) {
    const p = pct ? Math.max(0, Math.min(100, pct)) : 0;
    return `<div style="display:flex;align-items:center;margin:12px 0;">
                  <div style="width:140px;font-weight:600">${label}</div>
                  <div style="background:#eee;width:300px;height:16px;border-radius:4px;overflow:hidden;margin-left:8px">
                      <div style="width:${p}%;height:100%;background:${color};"></div>
                  </div>
                  <div style="min-width:60px;text-align:right;margin-left:12px;font-weight:600">${p.toFixed(1)}%</div>
              </div>`;
  }

  function stackedSingleBarHtml(s,u,p,w=420) {
    const sum = (s||0)+(u||0)+(p||0);
    const ws = sum? (s/sum)*100:0, wu = sum? (u/sum)*100:0, wp = sum? (p/sum)*100:0;
    return `<div style="display:flex;align-items:center;gap:12px;margin:16px 0;">
                  <div style="width:160px;font-weight:600">Broadband Access</div>
                  <div style="background:#eee;width:${w}px;height:18px;border-radius:4px;overflow:hidden;display:flex">
                      <div style="width:${ws}%;background:#2ca25f" title="Served: ${s.toFixed(1)}%"></div>
                      <div style="width:${wu}%;background:#f1c40f" title="Underserved: ${u.toFixed(1)}%"></div>
                      <div style="width:${wp}%;background:#e34a33" title="Priority Underserved: ${p.toFixed(1)}%"></div>
                  </div>
                  <div style="min-width:180px;text-align:right">${s.toFixed(1)}% served • ${u.toFixed(1)}% underserved • ${p.toFixed(1)}% priority</div>
              </div>`;
  }

  async function init() {
    const tj = await (await fetch(TILEJSON_URL)).json();
    const sourceLayer = tj.vector_layers?.[0]?.id;
    const style = {
      version: 8,
      sources: {
        osm: {
          type: "raster",
          tiles: ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
          tileSize: 256
        },
        "holc-tiles": {
          type: "vector",
          url: TILEJSON_URL
        }
      },
      layers: [{
        id: 'osm',
        type: 'raster',
        source: 'osm'
      }]
    };

    const map = new maplibregl.Map({
      container: 'map',
      style,
      center: [-121.8863, 37.3275],
      zoom: 12
    });
    window._map = map;

    // Add zoom controls
    document.getElementById('zoom-in').addEventListener('click', () => {
      map.zoomIn();
    });

    document.getElementById('zoom-out').addEventListener('click', () => {
      map.zoomOut();
    });

    // Add home button functionality
    document.getElementById('home-btn').addEventListener('click', () => {
      map.flyTo({
        center: [-121.8863, 37.3275],
        zoom: 12,
        essential: true
      });
    });

    map.on('load', () => {
      // Add HOLC polygons
      map.addLayer({
        id: 'holc-fill',
        type: 'fill',
        source: 'holc-tiles',
        'source-layer': sourceLayer,
        paint: {
          'fill-color': [
            'match',
            ['get', 'grade'],
            'A', '#2ca25f',
            'B', '#1f78b4',
            'C', '#f1c40f',
            'D', '#e34a33',
            '#999'
          ],
          'fill-opacity': 0.65
        }
      });

      map.addLayer({
        id: 'holc-line',
        type: 'line',
        source: 'holc-tiles',
        'source-layer': sourceLayer,
        paint: {
          'line-color': '#222',
          'line-width': 1
        }
      });

      // Add infrastructure layers
      // Rail
      map.addSource('rail', {
        type: 'geojson',
        data: 'https://api.maptiler.com/data/01990e77-7d61-7687-8575-6e804eb532f6/features.json?key=PrTVbrUk3PBatpAWhyvh'
      });

      map.addLayer({
        id: 'rail-line',
        type: 'line',
        source: 'rail',
        layout: { visibility: 'none' },
        paint: {
          'line-color': '#000000',
          'line-width': 2,
          'line-dasharray': [2, 2]
        }
      });

      // Light Rail - updated with brighter green and thicker line
      map.addSource('light-rail', {
        type: 'geojson',
        data: 'https://api.maptiler.com/data/0199215c-1501-7b68-9122-47e0167261d4/features.json?key=PrTVbrUk3PBatpAWhyvh'
      });

      map.addLayer({
        id: 'light-rail-line',
        type: 'line',
        source: 'light-rail',
        layout: { visibility: 'none' }, // Changed to not visible by default
        paint: {
          'line-color': '#4CAF50', // Bright green
          'line-width': 4, // Thicker line
        }
      });

      // Broadband Anchors
      map.addSource('broadband-anchors', {
        type: 'geojson',
        data: 'https://api.maptiler.com/data/01992159-807d-79ae-93a9-a66d86e84ca9/features.json?key=PrTVbrUk3PBatpAWhyvh'
      });

      map.addLayer({
        id: 'broadband-anchors-point',
        type: 'circle',
        source: 'broadband-anchors',
        layout: { visibility: 'none' },
        paint: {
          'circle-radius': 4,
          'circle-color': '#3498db',
          'circle-stroke-width': 1,
          'circle-stroke-color': '#fff'
        }
      });

      // State Defined DACs
      map.addSource('dacs', {
        type: 'geojson',
        data: 'https://api.maptiler.com/data/01998e9c-219b-70a8-a475-3dc8a6dd4418/features.json?key=PrTVbrUk3PBatpAWhyvh'
      });

      map.addLayer({
        id: 'dacs',
        type: 'fill',
        source: 'dacs',
        layout: {
          visibility: 'none'
        },
        paint: {
          'fill-color': '#3498db',       // Blue color
          'fill-opacity': 0.4,           // Slightly transparent
          'fill-outline-color': '#ffffff' // White border
        }
      });

      // Outline layer (for thicker borders)
      map.addLayer({
        id: 'dacs-outline',
        type: 'line',
        source: 'dacs',
        layout: { visibility: 'none' },
        paint: {
          'line-color': '#ffffff',
          'line-width': 2 // increase this for thicker outline
        }
      });

      // NO2 Raster Layer - with reprojection
      map.addSource('no2-raster', {
        type: 'raster',
        tiles: [
          'https://titiler.xyz/cog/tiles/WebMercatorQuad/{z}/{x}/{y}@1x.png?url=https://raw.githubusercontent.com/26arajesh/san-jose-redlining-map/main/no2_summerwinter.tif&rescale=1.15e15,5.64e15&colormap_name=rdylgn_r&resampling=nearest'
        ],
        tileSize: 256,
        attribution: 'NO₂ Data'
      });

      map.addLayer({
        id: 'no2-layer',
        type: 'raster',
        source: 'no2-raster',
        layout: { visibility: 'none' },
        paint: {
          'raster-opacity': 0.7,
          'raster-resampling': 'nearest'  // Keep pixels sharp
        }
      });

      const popup = new maplibregl.Popup({
        closeButton: true,
        closeOnClick: true,
        maxWidth: '380px'
      });

      map.on('mousemove', 'holc-fill', e => {
        const props = e.features[0].properties;
        document.getElementById('info').innerHTML = `<strong>${getMapped(props, 'label') || 'Zone'}</strong><br/>Grade: ${getMapped(props, 'grade') || 'N/A'}`;
      });

      map.on('mouseleave', 'holc-fill', () => document.getElementById('info').innerText = 'Click on a zone for more info');

      map.on('click', 'holc-fill', e => {
        const props = e.features[0].properties;
        const grade = getMapped(props, 'grade'), label = getMapped(props, 'label');
        const median = parseNumberFlexible(getMapped(props, 'median'));
        const pctWhite = parseNumberFlexible(getMapped(props, 'pct_white'));
        const pctBlack = parseNumberFlexible(getMapped(props, 'pct_black'));
        const pctAsian = parseNumberFlexible(getMapped(props, 'pct_asian'));
        const pctHisp = parseNumberFlexible(getMapped(props, 'pct_hisp'));
        const pctNative = parseNumberFlexible(getMapped(props, 'pct_native'));
        const broadbandAnchors = parseNumberFlexible(getMapped(props, 'broadband_anchors'));
        const streetTrees = parseNumberFlexible(getMapped(props, 'street_trees'));
        const railLength = parseNumberFlexible(getMapped(props, 'rail_length')) || 0;
        const lightRailLength = parseNumberFlexible(getMapped(props, 'light_rail_length')) || 0;
        const bs = parsePercent(getMapped(props, 'broadband_served'));
        const bu = parsePercent(getMapped(props, 'broadband_underserved'));
        const bp = parsePercent(getMapped(props, 'broadband_priority'));

        let html = `<div class="popup-table"><div class="popup-scroll">
                          <div><span class="metric">Grade:</span> ${grade}<br/><span class="metric">Label:</span> ${label}</div>
                          <div><span class="metric">Median Housing Value:</span> ${median ? '$' + formatNumber(median) : 'N/A'}</div>
                          <div><strong>Race %</strong>
                              ${miniInlineBar('White', pctWhite, '#1f78b4')}
                              ${miniInlineBar('Black', pctBlack, '#6a3d9a')}
                              ${miniInlineBar('Asian', pctAsian, '#b15928')}
                              ${miniInlineBar('Hispanic', pctHisp, '#ff7f00')}
                              ${miniInlineBar('Native', pctNative, '#777')}
                          </div>
                          <div><strong>Counts</strong>
                              <div>Broadband Anchors: ${formatNumber(broadbandAnchors)}</div>
                              <div>Street Trees: ${formatNumber(streetTrees)}</div>
                              <div>Rail Length: ${railLength.toFixed(1)} km</div>
                              <div>Light Rail Length: ${lightRailLength.toFixed(1)} km</div>
                          </div>
                          <div><strong>Broadband %</strong>
                              ${stackedSingleBarHtml(bs || 0, bu || 0, bp || 0, 180)}
                          </div>
                      </div></div>`;

        // Add fullscreen button to popup
        html += `<button class="fullscreen-btn" onclick="showFullscreenDetails(${JSON.stringify(props).replace(/"/g, '&quot;')})">
                  <i class="fas fa-expand"></i> View Full Details
                </button>`;

        popup.setLngLat(e.lngLat).setHTML(html).addTo(map);
      });

      // Layer toggles
      document.getElementById('toggle-holc').onchange = (e) => {
        const v = e.target.checked ? 'visible' : 'none';
        map.setLayoutProperty('holc-fill', 'visibility', v);
        map.setLayoutProperty('holc-line', 'visibility', v);
      };

      document.getElementById('toggle-rail').onchange = (e) => {
        const v = e.target.checked ? 'visible' : 'none';
        map.setLayoutProperty('rail-line', 'visibility', v);
      };

      document.getElementById('toggle-light-rail').onchange = (e) => {
        const v = e.target.checked ? 'visible' : 'none';
        map.setLayoutProperty('light-rail-line', 'visibility', v);
      };

      document.getElementById('toggle-broadband').onchange = (e) => {
        const v = e.target.checked ? 'visible' : 'none';
        map.setLayoutProperty('broadband-anchors-point', 'visibility', v);
      };

      document.getElementById('toggle-dacs').onchange = (e) => {
        const v = e.target.checked ? 'visible' : 'none';
        map.setLayoutProperty('dacs', 'visibility', v);
        map.setLayoutProperty('dacs-outline', 'visibility', v);
      };

      document.getElementById('toggle-no2').onchange = (e) => {
        const v = e.target.checked ? 'visible' : 'none';
        map.setLayoutProperty('no2-layer', 'visibility', v);
        document.getElementById('no2-legend').style.display = e.target.checked ? 'block' : 'none';
      };
    });
  }


  init();
</script>
</body>
</html>